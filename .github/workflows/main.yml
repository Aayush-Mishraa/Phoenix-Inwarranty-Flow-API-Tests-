name: Phoenix In-Warranty Postman API Collection Workflow Tests

on:
  push:
    branches: [main]
  workflow_dispatch:
  schedule:
    # Production Schedules
    - cron: '30 02 * * *'      # Daily at 8:00 AM IST
    - cron: '00 14 * * 0-1'    # Sun-Mon at 7:30 PM IST
    
    # Weekday Schedules (Mon-Fri / Tue-Fri)
    - cron: '00 01 * * 2-5'    # Tue-Fri at 6:30 AM IST
    - cron: '00 09 * * 2-5'    # Tue-Fri at 2:30 PM IST
    - cron: '00 06 * * 2-5'    # Tue-Fri at 11:30 AM IST
    - cron: '00 06 * * 1-2'    # Mon-Tue at 11:30 AM IST
    
    # Tue-Wed Schedules
    - cron: '00 10 * * 2-3'    # Tue-Wed at 3:30 PM IST
    - cron: '00 04 * * 2-3'    # Tue-Wed at 9:30 AM IST
    - cron: '00 08 * * 2-3'    # Tue-Wed at 1:30 PM IST (Staging)
    
    # Staging Build Schedules
    - cron: '00 05 * * 2-4'    # Tue-Thu at 10:30 AM IST (Staging)
    
    # Demo/Testing Schedules
    - cron: '00 02 * * 2-3'    # Tue-Wed at 7:30 AM IST
    - cron: '30 02 * * 2-3'    # Tue-Wed at 8:00 AM IST
    - cron: '00 03 * * 2-3'    # Tue-Wed at 8:30 AM IST
    - cron: '40 05 * * 2-3'    # Tue-Wed at 11:10 AM IST
    - cron: '00 11 * * 2-3'    # Tue-Wed at 4:30 PM IST
    - cron: '00 12 * * 2-3'    # Tue-Wed at 5:30 PM IST
    - cron: '00 13 * * 2-3'    # Tue-Wed at 6:30 PM IST
    - cron: '00 16 * * 2-3'    # Tue-Wed at 9:30 PM IST
    - cron: '00 17 * * 2-3'    # Tue-Wed at 10:30 PM IST
    - cron: '00 18 * * 2-3'    # Tue-Wed at 11:30 PM IST
    - cron: '00 19 * * 2-3'    # Tue-Wed at 12:30 AM IST (next day)
    - cron: '00 20 * * 2-3'    # Tue-Wed at 1:30 AM IST (next day)

jobs:
  run-postman-tests:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout the code
        uses: actions/checkout@v4

      - name: Install Node.js and npm
        uses: actions/setup-node@v4
        with:
          node-version: '22'

      - name: Install Newman and HTML Extra globally
        run: |
          npm install -g newman
          npm install -g newman-reporter-htmlextra

      - name: Run Postman Collection
        run: |
          newman run 'Main Inwarranty-flow Collection.postman_collection.json' \
            -e QA.postman_environment.json \
            -d testdata.csv \
            -r cli,htmlextra \
            --reporter-htmlextra-export newman/index.html \
            --reporter-htmlextra-showOnlyFails \
            --reporter-htmlextra-omitRequestBodies \
            --reporter-htmlextra-omitResponseBodies

      - name: Upload Newman Report
        if: always()
        uses: actions/upload-artifact@v4.6.2
        with:
          name: newman-html-report
          path: newman/*.html

      - name: Create GitHub HTML page branch
        if: always()
        uses: peaceiris/actions-gh-pages@v4.0.0
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_dir: newman/

      - name: Send email notification
        if: always()
        uses: dawidd6/action-send-mail@v6
        with:
          server_address: smtp.gmail.com
          server_port: 465
          username: ${{ secrets.EMAIL_ADDRESS }}
          password: ${{ secrets.EMAIL_PASSWORD }}
          subject: Phoenix In-Warranty Flow | API Automation Test Report (GitHub Actions)
          to: connecttoayushmishra@gmail.com
          from: Phoenix Automation | Aayush Mishra <${{ secrets.EMAIL_ADDRESS }}>
          body: |
            Hello,

            The Phoenix In-Warranty Flow Postman API tests have been successfully executed via GitHub Actions.
            
            Please find the attached HTML test execution report for detailed results.
            You can also view the live report on GitHub Pages using the link below:
            https://aayush-mishraa.github.io/Phoenix-Inwarranty-Flow-API-Tests-/
            
            If you have any questions or need further details, please let me know.
            
            Warm regards,  
            ━━━━━━━━━━━━━━━━━━━━━━━━━━  
            Aayush Mishra  
            SDET | Software Development Engineer in Test  
            Automation • API • CI/CD  
            https://aayushmishra.tech/  
            ━━━━━━━━━━━━━━━━━━━━━━━━━━
